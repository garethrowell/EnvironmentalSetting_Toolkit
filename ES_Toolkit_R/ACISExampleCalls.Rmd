
---
title: "Environmental Setting Metrics - Example ACIS Calls"
author: "Lisa Nelson - IMD"
date: "February 15, 2018"
output: html_document
highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(EnvironmentalSettingToolkit)
```

```{r include=FALSE, message=FALSE, warning=FALSE, error=FALSE}
dataPlot <- function(plotDF,plotY,yLabel) {
  # Iterate observations, graphing a scatter plot for each station
  plot.new()
  par(pin=c(6,6))
  par(mfrow = c(length(unique(plotDF$uid)), 1)) # All station graphs in one page column
  par(mar = c(4.5, 4.5, 1.5, 1.5)) # Graph margins in lines
  for (s in unique(plotDF$uid)) {
    plot(
      CST1Data$date[which(plotDF$uid == s)],
      plotY[which(plotDF$uid == s)],
      pch = 16,
      col = "blue",
      ylab = yLabel,
      xlab = "date",
      cex.main=0.8,
      main = plotDF$name[which(plotDF$uid == s)][1]
    )
  }
}
```
The protocol calculates four types of climate metrics. 

* station-based temperature and precipitation
* station-based departures from normal temperature and precipitation
* grid-based departures from normal temperature and precipitation
* index-based precipitation and drought

The first two metric types are calculated for all stations within the 12-digit hydrologic units (HUC) that intersect parks while the latter two metric types are calculated by area of analysis (AOA) exent.

```{r results = "asis", echo=FALSE}
metrics <- read.csv("inst/ESParameters.csv")[ ,1:2]
knitr::kable(metrics, type = "html")
```

# Station-Based Temperature and Precipitation Metrics
Examples shown are for stations within 20km of Agate Fossil Beds National Monument (AGFO). These are raw data that include missing values. Note not all station-based metrics are shown.
``` {r message=FALSE, warning=FALSE, error=FALSE}
# Get stations collecting maxt, mint, and gdd with data from last 20 years
testStations <- findStation(unitCode = "AGFO", distance = 20, climateParameters = list("maxt","mint","gdd"))
currentStations <- testStations[testStations$maxDate >= "2018-02-10" & testStations$minDate >= "1998-02-10",]
str(currentStations)

```

Data requests are made with the getWxObservations() function. Plot are shown in this notebook but are not in the Toolkit functions.

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST1: Hot Days (annual count)
CST1Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("maxt"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_ge_90")
CST1Data$maxt_F_cnt_ge_90
```
```{r echo=FALSE, dpi=96, fig.width=8, fig.height=7, message=FALSE, warning=FALSE, error=FALSE}
# Iterate observations, graphing a scatter plot for each station
plot.new()
par(pin=c(6,6))
par(mfrow=c(length(unique(CST1Data$uid)),1)) # All station graphs in one page column
par(mar=c(4.5,4.5,1.5,1.5)) # Graph margins in lines
for (s in unique(CST1Data$uid)) {
  plot(CST1Data$date[which(CST1Data$uid == s)], CST1Data$maxt_F_cnt_ge_90[which(CST1Data$uid == s)], pch=16, col="blue", ylab="annual count (CST1)", xlab="date", cex.main=0.8, main=CST1Data$name[which(CST1Data$uid == s)][1])
}
```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST2: Cold Days (annual count)
CST2Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("maxt"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_le_32")
CST2Data$maxt_F_cnt_le_32
```

```{r echo=FALSE, dpi=96, message=FALSE, warning=FALSE, error=FALSE}
dataPlot(CST2Data,CST2Data$maxt_F_cnt_le_32,"annual count (CST2)")

```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST3: Sub-freezing Days
CST3Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("mint"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_le_32")
CST3Data$mint_F_cnt_le_32
```

```{r echo=FALSE, dpi=96, message=FALSE, warning=FALSE, error=FALSE}
dataPlot(CST3Data,CST3Data$mint_F_cnt_le_32,"annual count (CST3)")

```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST4: Days at or below 0 (annual count)
CST4Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("mint"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_le_0")
CST4Data$mint_F_cnt_le_0
```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST5: Growing degree days (base temperature >= 32) (annual count)
CST5Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("gdd"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_gt_0")
CST5Data$gdd__cnt_gt_0

```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST6: Heating degree days (default base temperature >= 65) (annual count)
CST6Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("hdd"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_gt_0")
CST6Data$hdd__cnt_gt_0
```

```{r message=FALSE, warning=FALSE, error=FALSE}
# Get CST7: Cooling degree days (default base temperature >= 65) (annual count)
CST7Data <- getWxObservations(climateStations = unique(currentStations$uid), climateParameters = list("cdd"), sdate="1998-02-10", duration="yly", interval = "yly", reduceCodes = "cnt_gt_0")
CST7Data$cdd__cnt_gt_0
```
